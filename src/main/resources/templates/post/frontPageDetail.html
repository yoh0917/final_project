<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title th:text="${postTitle}">文章詳情</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
	crossorigin="anonymous">
 

<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="Content-Type" content="text/html; charset=utf-8" />
	<!-- <link th:href="@{/shoppingcart/cart/css/bootstrap.css}" rel="stylesheet" type="text/css" media="all" /> -->
	<link th:href="@{/shoppingcart/cart/css/style.css}" rel="stylesheet" type="text/css" media="all" />
	<!-- <script th:src="@{/shoppingcart/cart/js/jquery.min.js}"></script> -->
	<!-- <script th:src="@{/shoppingcart/cart/js/simpleCart.min.js}"></script> -->
	<link th:href="@{/shoppingcart/cart/css/jquery-ui.css}" rel="stylesheet" type="text/css">
	<!-- <script th:src="@{/shoppingcart/cart/js/bootstrap-3.1.1.min.js}" type="text/javascript"></script> -->
	<link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,300italic,400italic,600,600italic,700,700italic,800,800italic" rel="stylesheet" type="text/css">
	<link href="https://fonts.googleapis.com/css?family=Lato:400,100,100italic,300,300italic,400italic,700,700italic,900,900italic" rel="stylesheet" type="text/css">
	<link th:href="@{/shoppingcart/cart/css/animate.min.css}" rel="stylesheet">
	<link th:href="@{/css/styles.css}" rel="stylesheet" />
	<script th:src="@{/shoppingcart/cart/js/wow.min.js}"></script>
	<div th:replace="~{/layout/headerStylesheet.html}"></div>
	<!-- <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script> -->
	
	<link th:href="@{/layout/css/header.css}" rel="stylesheet"> 
	
	 
   <style>
   		
   		/* header 樣式 */
		
		.top-bar {
		    width: 100%;
		    padding: 9px 0;
		    background: black;
		    color: white;
		    text-align: center;
		    font-size: 14px;
		    position: fixed;
		    top: 0;
		    left: 0;
		    z-index: 1000;
		}
		
		.top-bar a {
		    color: white;
		    font-weight: 500;
		    text-decoration: underline;
		}
		.navbar .icons {
			padding-right:100px;
		}
		
		 .navbar .icons a{
	        	color: black !important;
	        	
	        }
		
		.navbar .logo img {
		    width: 180px;
		    height: auto;
		}
		
		.navbar .menu {
		    display: flex;
		    gap: 24px;
		}
		
		
		.navbar .menu a:hover {
		    text-decoration: underline;
		}
		
		.navbar .menu-item {
		    position: relative;
		}
		
		.navbar .menu-item:hover .submenu {
		    display: block;
		}
		
		.header-row {
		    display: flex;
		    border-radius: 5px;
		    justify-content: space-between;
		    align-items: center;
		    margin-bottom: 20px;
		}
		
		.header-row2 {
		    display: flex;
		    color: #8E8E8E;
		    border-radius: 5px;
		    align-items: center;
		}
		/*  */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Satoshi', sans-serif;
            background-color: #f8f9fa;
            padding-top: 130px;
            background-color: #ADADAD;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            position: relative;
            padding-bottom: 120px; /* 給留言表單留出空間 */
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: white;
            position: fixed;
            top: 40px;
            left: 0;
            width: 100%;
            z-index: 1000;
        }

        .navbar .menu {
            display: flex;
            gap: 24px;
        }

        .navbar .menu a {
            font-size: 16px;
            color: black;
            text-decoration: none;
            position: relative;
            padding: 10px 0;
            line-height: 1;
        }

        .navbar .menu a:hover {
            text-decoration: underline;
        }

        .navbar .menu-item {
            position: relative;
        }

        .navbar .menu-item:hover .submenu {
            display: block;
        }

        .header-row {
            display: flex;
            border-radius: 5px;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header-row2 {
            display: flex;
            color: #8E8E8E;
            border-radius: 5px;
            align-items: center;
        }

       
        .postCreatedTime {
            color: #8E8E8E;
		    display: flex;
		    justify-content: space-between;
		    align-items: center;
		}
		
		.edit-button-container {
		    margin-left: auto; /* 確保編輯按鈕靠右 */
		}
		
		.btn-icon {
		    background: none;
		    border: none;
		    color: #343a40;
		    cursor: pointer;
		    display: flex;
		    align-items: center;
		}
		
		.btn-icon:hover {
		    color: #495057;
		}

        .tags-container {
            margin-right: 20px;
        }

        .space-right {
            margin-right: 10px;
        }

        .userName {
            margin-right: 10px;
        }

        .header-row h1 {
            font-size: 2rem;
            margin: 0;
        }

        .actions a {
            margin-left: 10px;
        }

        .post-content {
            margin-bottom: 40px;
        }

        .post-content h2 {
            margin-bottom: 20px;
        }

        .post-content p {
            line-height: 1.6;
        }

        .comments-section {
            margin-top: 40px;
        }

        .comments-section h3 {
            margin-bottom: 20px;
        }

        .comment {
            padding: 10px;
            background: #f1f1f1;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            
        }
        
        .comment-header strong {
            margin-right: 10px; 
        }
        .comment-right-options {
		    display: flex;
		    align-items: center;
		    gap: 10px; /* 控制各圖標之間的間距 */
		}
		.comment-like-container {
		    display: flex;
		    align-items: center;
		    font-size: 0.8em;
		}
		
		.separator {
		    border-left: 1px solid #ccc;
		    height: 20px;
		    margin: 0 5px;
		}
		
		.comment-options {
		    display: flex;
		    align-items: center;
		}
		.comment-options i {
		    font-size: 1.2em; /* 統一圖標大小 */
		}
		
		.btn-icon {
		    background: none;
		    border: none;
		    color: #343a40;
		    cursor: pointer;
		    /* display: flex; */
		   /*  padding-left: 65px; */
		    /* align-items: center; */
		}
		.btn-icon2{
		    margin-right: 20px;
		}
		
		.btn-icon:hover {
		    color: #495057;
		}
        .comment-time {
    		
    		color: #8E8E8E; /* 設置顏色，使其與用戶名區分開來 */
		}

        .comment-form {
            margin-top: 20px;
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 800px;
            background: white;
            padding: 10px;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .comment-form form {
            display: flex;
            gap: 10px;
            height:50px;
        }

        .comment-form textarea {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }

        .comment-form button {
            padding: 10px 20px;
            background: #343a40;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .comment-form button:hover {
            background: #495057;
        }
        
        .comment-form .btn-icon {
            background: none;
            border: none;
            color: #343a40;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .comment-form .btn-icon:hover {
            color: #495057;
        }
        

        .fa-pen-to-square {
            cursor: pointer;
        }

        .comment-options {
            position: relative;
            display: flex;
            align-items: center;
        }

        .comment-options .dropdown-menu {
            right: 0;
            left: auto;
            transform: translateX(-100%);
        }

        .comment-options .dropdown-menu::before {
            content: "";
            position: absolute;
            top: 10px;
            right: -10px;
            width: 10px;
            height: 10px;
            background: white;
            transform: rotate(45deg);
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        }
        .like-container {
            display: flex;
            align-items: end;
            justify-content:space-between;
            margin-left: auto; 
        }
        .right-container{
        	display: flex;
        	flex-direction:row;
            align-items: end;
            gap: 0;
        }
        .favorite-form {
		    margin-right: 10px; /* 確保按鈕之間有間距 */
		}
        .like-display, .btn-icon {
		    display: flex;
		    align-items: center;
		    font-size: 1.5em; 
		}
        .like-display i, .btn-icon i {
   			 margin-right: 5px; 
		}
		.comment-like-container{
			display:flex;
			align-items: center;
		    font-size: 0.8em;
		}

		.like-display span, .btn-icon i {
			
    		line-height: 1.5em; 
		}	

		.btn-icon {
			margin-left: 10px; /* 確保按鈕之間有間距 */
		    background: none;
		    border: none;
		    color: #343a40;
		    cursor: pointer;
		    display: flex;
   			align-items: center;
		}
		

		.btn-icon:hover {
   			 color: #495057;
		}

        .like-container button.btn-icon {
            background: none;
            border: none;
            color: #343a40;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
             margin-left: auto; 
        }

        .like-container button.btn-icon:hover {
            color: #495057;
        }
		.reply-container {
		    margin-left: 20px;
		    margin-top: 10px;
			}
		
		.reply {
			
		    background-color: #f8f9fa;
		    border-left: 3px solid 	#005AB5;
		    padding: 10px;
		    margin-bottom: 10px;
		}
		
		.reply-header {
		    margin-bottom: 5px;
		}
		
		.reply-time {
		    font-size: 0.8em;
		    color: #6c757d;
		}
		
		.reply-quote {
		    background-color: #e9ecef;
		    border-left: 2px solid #6c757d;
		    padding: 5px;
		    margin-bottom: 5px;
		    font-size: 0.9em;
		}
		
		.quote-author {
		    font-weight: bold;
		}
		
		.quote-content {
		    color: #6c757d;
		}
    </style>
</head>
<body>
<div th:replace="~{layout/header}"></div>

<div class="container">
    <div class="header-row2">
        <div class="tags-container">
            <span th:each="tag : ${post.tags}" th:text="${tag.name}" class="badge bg-secondary"></span>
        </div>
        <strong class="userName" th:text="${post.user != null ? post.user.userName : '未知用戶'}">用戶名</strong>
        <strong class="userId" th:text="${post.user != null ? post.user.userId : '未知id'}">用戶id</strong>
    </div>
    <br>
    <div class="header-row">
        <h1 th:text="${postTitle}">文章標題</h1>
        <div class="actions">
            <a class="btn btn-outline-dark" th:href="@{/post/frontPage}">回列表</a>
        </div>
    </div>
    <hr>

    <div class="postCreatedTime">
    <span th:text="${#dates.format(post.postCreatedTime, 'yyyy-MM-dd HH:mm:ss')}">發布時間</span>
    
    <div class="edit-button-container" th:if="${post.user != null and currentUserId == post.user.userId}">
    <i class="fa-solid fa-ellipsis-vertical" id="postOptionsButton" data-bs-toggle="dropdown" aria-expanded="false"></i>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="postOptionsButton">
        <li><a class="dropdown-item" th:href="@{'/post/editFront/' + ${post.postId}}"><i class="fa-solid fa-pen-to-square"></i> 編輯貼文</a></li>
        <li>
            <form th:action="@{/post/delete}" method="post" onsubmit="return confirm('確定要刪除這篇貼文嗎？');">
			    <input type="hidden" name="id" th:value="${post.postId}" />
			    <button type="submit" class="dropdown-item">
			        <i class="fa-solid fa-trash"></i> 刪除貼文
			    </button>
			</form>
        </li>
    </ul>
</div>
</div>
	<!-- 編輯貼文模態視窗 -->
<div class="modal fade" id="editPostModal" tabindex="-1" aria-labelledby="editPostModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPostModalLabel">編輯貼文</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editPostForm">
                    <input type="hidden" id="editPostId" name="postId" th:value="${post.postId}">
                    <div class="mb-3">
                        <label for="editPostTitle" class="form-label">標題</label>
                        <input type="text" class="form-control" id="editPostTitle" name="title" th:value="${post.title}">
                    </div>
                    <div class="mb-3">
                        <label for="editPostContent" class="form-label">內容</label>
                        <textarea class="form-control" id="editPostContent" name="postContent" th:text="${post.postContent}"></textarea>
                    </div>
                    <button type="submit" class="btn btn-secondary">提交</button>
                </form>
            </div>
        </div>
    </div>
</div>

    <div class="post-content">
        <p th:utext="${postContent}">文章內容顯示在這裡</p>
    </div>
    
    <!-- 點讚動作 -->
    <div class="like-container">
    	<!-- 左邊的按钮，只顯示圖示和讚數，不具備點擊功能 -->
    	<div class="like-display">
       		<i class="fa-regular fa-heart"></i>
        	<span id="likeCount" th:text="${post.likeCount}">0</span>
    	</div>
		
		<div class="right-container">
    	<!-- 右邊的按钮，可以點擊但不顯示讚數 -->
    	<button id="likeButton" class="btn-icon btn-icon2" data-post-id="${post.postId}" th:classappend="${hasLiked ? 'liked' : ''}" th:onclick="'toggleLike(' + ${post.postId} + ')'" style="margin-left: 10px;">
       		<i class="fa-regular fa-heart" id="likeIcon"></i>
    	</button>
    	<!-- 收藏按紐 -->
           <form th:action="@{/post/favorite/toggle}" method="post" class="favorite-form">
		    <input type="hidden" name="postId" th:value="${post.postId}">
		    <button type="submit" class="btn-icon" th:classappend="${isFavorited ? 'favorited' : ''}">
		        <i class="fa-star" th:classappend="${isFavorited ? 'fa-solid' : 'fa-regular'}"></i> 
		    </button>
			</form>
		</div>
	</div>
	
    <hr>
    <!-- 留言區 -->
    <div class="comments-section">
    <h3>留言</h3>
    <div th:each="comment : ${comments}">
    <div class="comment">
    <div class="comment-header">
    <strong th:text="${comment.users != null ? (comment.users.userName + (comment.users.userId == post.user.userId ? ' （樓主)' : '')) : '未知用戶'}">用戶名</strong>
    
    <div class="comment-right-options">
        <!-- 點讚功能 -->
        <div class="comment-like-container">
            <button class="comment-like-button btn-icon" th:attr="onclick='toggleCommentLike(' + ${comment.commentId} + ')'">
                <i class="fa-regular fa-heart" th:classappend="${comment.likedUsers.contains(currentUser) ? 'fa-solid' : ''}" th:id="'comment-like-icon-' + ${comment.commentId}"></i>
            </button>
            <span th:id="'comment-like-count-' + ${comment.commentId}" th:text="${comment.likeCount}">0</span>
        </div>
        
        <div class="separator"></div>

        <!-- 編輯刪除動作 -->
        <div class="comment-options">
            <th:block th:if="${comment.users != null and currentUserId == comment.users.userId}">
                <i class="fa-solid fa-pen-to-square" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false"></i>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <li>
                        <a class="dropdown-item" href="#" th:attr="onclick='editComment(\'' + ${comment.commentId} + '\', \'' + ${comment.commentContent} + '\', \'' + ${post.postId} + '\')'">
                            <i class="fa-solid fa-pen-to-square"></i> 編輯留言
                        </a>
                    </li>
                    <li>
                        <form th:action="@{/comment/delete}" method="post" style="display:inline;" onsubmit="return confirmDelete()">
                            <input type="hidden" name="commentId" th:value="${comment.commentId}" />
                            <input type="hidden" name="postId" th:value="${post.postId}" />
                            <button class="dropdown-item" type="submit">
                                <i class="fa-solid fa-trash"></i> 刪除
                            </button>
                        </form>
                    </li>
                </ul>
            </th:block>
            <th:block th:if="${comment.users == null or currentUserId != comment.users.userId}">
                <i class="fa-solid fa-ellipsis-vertical" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false"></i>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                    <li><a class="dropdown-item" href="#">檢舉</a></li>
                </ul>
            </th:block>
        </div>
    </div>
</div>
    <span th:text="${comment.commentContent}">評論內容</span><br>
    <span class="comment-time" th:text="${#temporals.format(comment.commentCreatedTime, 'yyyy-MM-dd HH:mm:ss')}">評論時間</span>
    <!-- <span class="badge bg-secondary" th:data-comment-id="${comment.commentId}">回覆</span> -->
    <span class="badge bg-secondary reply-button" th:onclick="'toggleReplyForm(\'' + ${comment.commentId} + '\')'">回覆</span>


    <!-- 回覆表單 -->
<div th:id="'reply-form-' + ${comment.commentId}" style="display: none;">
    <form th:action="@{/comment/add}" method="post">
        <input type="hidden" name="postId" th:value="${post.postId}">
        <input type="hidden" name="userId" th:value="${session.userId}">
        <input type="hidden" name="parentCommentId" th:value="${comment.commentId}">
        <textarea name="commentContent" placeholder="回覆..."></textarea>
        <button type="submit" class="badge bg-secondary reply-button">送出</button>
    </form>
</div>
</div>

<!-- 顯示回覆 -->
<div th:each="reply : ${comment.replies}" class="reply-container">
    <div class="reply">
        <div class="reply-header">
            <strong th:text="${reply.users.userName}">回覆用戶</strong>
            <span class="reply-time" th:text="${#temporals.format(reply.commentCreatedTime, 'yyyy-MM-dd HH:mm:ss')}">回覆時間</span>
            <span class="reply-to">回覆 
                <strong th:text="${comment.users.userName}">原評論作者</strong>
            </span>
        </div>
        <span th:text="${reply.commentContent}">回覆內容</span>
    </div>
</div>

<!-- 編輯留言模態視窗 -->
<div class="modal fade" id="editCommentModal" tabindex="-1" aria-labelledby="editCommentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCommentModalLabel">編輯留言</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editCommentForm">
                    <input type="hidden" id="editCommentId" name="commentId">
                    <input type="hidden" id="editPostId" name="postId">
                    <div class="mb-3">
                        <label for="editCommentContent" class="form-label">留言內容</label>
                        <textarea class="form-control" id="editCommentContent" name="commentContent"></textarea>
                    </div>
                    <button type="submit" class="btn btn-secondary">保存修改</button>
                </form>
            </div>
        </div>
    </div>
</div>


<div class="comment-form">
    <form th:action="@{/comment/add}" method="post">
        <input type="hidden" name="postId" th:value="${post.postId}">
        <input type="hidden" name="userId" th:value="${session.userId}">
        <input type="hidden" name="userName" th:value="${session.userName}">
        <textarea name="commentContent" placeholder="留言..."></textarea>
        <button type="submit" class="btn-icon">
            <i class="fa-solid fa-paper-plane"></i>
        </button>
    </form>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
            $('.delete-post-btn').click(function(e) {
                e.preventDefault();
                var postId = $(this).data('post-id');
                if (confirm('確定要刪除這篇貼文嗎？')) {
                    $.ajax({
                        url: '/sellphone/post/delete',
                        type: 'POST',
                        data: { id: postId },
                        success: function(response) {
                            window.location.href = '/sellphone/post/frontPage';
                        },
                        error: function(xhr, status, error) {
                            console.error('Error:', error);
                            alert('刪除貼文失敗，請稍後再試。');
                        }
                    });
                }
            });
        });
 
function editPost() {
    var editPostModal = new bootstrap.Modal(document.getElementById('editPostModal'), {
        keyboard: false
    });
    editPostModal.show();
}



$(document).ready(function() {
    $('#editPostForm').submit(function(e) {
        e.preventDefault();
        var formData = $(this).serialize();
        $.ajax({
            url: '/sellphone/post/edit',
            type: 'POST',
            data: formData,
            success: function(response) {
                location.reload();
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                alert('編輯貼文失敗，請稍後再試。');
            }
        });
    });

    // 修改评论编辑表单的提交处理
    $('#editCommentForm').submit(function(e) {
        e.preventDefault();
        var formData = $(this).serialize();
        console.log("Form data:", formData); // 添加這行來查看發送的數據
        $.ajax({
            url: '/sellphone/comment/edit',
            type: 'POST',
            data: formData,
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('編輯失敗：' + response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                console.error('Status:', status);
                console.error('Response:', xhr.responseText);
                alert('編輯留言失敗，請稍後再試。');
            }
        });
    });
});

function editComment(commentId, commentContent, postId) {
    console.log("Editing comment with ID:", commentId);
    console.log("Comment content:", commentContent);
    console.log("Post ID:", postId);

    document.getElementById('editCommentId').value = commentId;
    document.getElementById('editCommentContent').value = commentContent;
    document.getElementById('editPostId').value = postId;

    var editCommentModal = new bootstrap.Modal(document.getElementById('editCommentModal'), {
        keyboard: false
    });

    editCommentModal.show();
}

function confirmDelete() {
    return confirm("确定要刪除這則留言嗎？");
}

$(document).ready(function() {
    $('#likeButton').click(function(event) {
        event.preventDefault(); 
        var postId = $(this).data('post-id');
        console.log('Like button clicked, postId:', postId);
        toggleLike(postId);
    });
});

function toggleLike(postId) {
    console.log('Sending like toggle request for postId:', postId);
    $.ajax({
        url: '/sellphone/post/like/toggle',
        type: 'POST',
        data: {
            postId: postId
        },
        success: function(response) {
            $('#likeCount').text(response.likeCount);
            $('#likeButton').toggleClass('liked', response.hasLiked);
            var icon = $('#likeIcon');
            if (response.hasLiked) {
                icon.removeClass('fa-regular').addClass('fa-solid');
            } else {
                icon.removeClass('fa-solid').addClass('fa-regular');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
            console.error('狀態:', status);
            console.error('回應:', xhr.responseText);
        }
    });
}

function toggleCommentLike(commentId) {
    console.log('Sending comment like toggle request for commentId:', commentId);
    $.ajax({
        url: '/sellphone/comment/like/toggle',
        type: 'POST',
        data: {
            commentId: commentId
        },
        success: function(response) {
            $('#comment-like-count-' + commentId).text(response.likeCount);
            var icon = $('#comment-like-icon-' + commentId);
            if (response.hasLiked) {
                icon.removeClass('fa-regular').addClass('fa-solid');
            } else {
                icon.removeClass('fa-solid').addClass('fa-regular');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
            console.error('狀態:', status);
            console.error('回應:', xhr.responseText);
        }
    });
}

   document.addEventListener('DOMContentLoaded', function() {
    // 使用事件委托处理回复按钮点击
    document.querySelector('.comments-section').addEventListener('click', function(event) {
        if (event.target.classList.contains('reply-button')) {
            var commentId = event.target.getAttribute('data-comment-id');
            toggleReplyForm(commentId);
        }
    });
});

function toggleReplyForm(commentId) {
    var replyForm = document.getElementById('reply-form-' + commentId);
    if (replyForm) {
        if (replyForm.style.display === 'none' || replyForm.style.display === '') {
            replyForm.style.display = 'block';
        } else {
            replyForm.style.display = 'none';
        }
    } else {
        console.error('Reply form not found for comment ID:', commentId);
    }
}

// 移除之前的事件监听器代码

      document.addEventListener('DOMContentLoaded', function() {
       var favoriteButton = document.getElementById('favoriteButton');
       if (favoriteButton) {
           favoriteButton.addEventListener('click', function() {
               var postId = this.getAttribute('data-post-id');
               var icon = document.getElementById('favoriteIcon');
               
               console.log('Toggling favorite for post:', postId);
               
               fetch('/sellphone/post/favorite/toggle', {
                   method: 'POST',
                   headers: {
                       'Content-Type': 'application/x-www-form-urlencoded',
                       'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').getAttribute('content')
                   },
                   body: 'postId=' + postId
               })
               .then(response => {
                   console.log('Response status:', response.status);
                   if (!response.ok) {
                       throw new Error('Network response was not ok');
                   }
                   return response.json();
               })
               .then(data => {
                   console.log('Received data:', data);
                   if (data.isFavorited) {
                       this.classList.add('favorited');
                       icon.classList.remove('fa-regular');
                       icon.classList.add('fa-solid');
                       console.log('Post favorited');
                   } else {
                       this.classList.remove('favorited');
                       icon.classList.remove('fa-solid');
                       icon.classList.add('fa-regular');
                       console.log('Post unfavorited');
                   }
               })
               .catch(error => {
                   console.error('Error:', error);
                   alert('操作失败，请稍后重试');
               });
           });
       }
   });

</script>
</body>
</html> 