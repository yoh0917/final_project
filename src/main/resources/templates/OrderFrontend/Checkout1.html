<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>結帳頁面</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="Content-Type" content="text/html; charset=utf-8" />
    <link th:href="@{/shoppingcart/cart/css/bootstrap.css}" rel="stylesheet" type="text/css" media="all" />
    <link th:href="@{/shoppingcart/cart/css/style.css}" rel="stylesheet" type="text/css" media="all" />
    <script th:src="@{/shoppingcart/cart/js/jquery.min.js}"></script>
    <script th:src="@{/shoppingcart/cart/js/simpleCart.min.js}"></script>
    <link th:href="@{/shoppingcart/cart/css/jquery-ui.css}" rel="stylesheet" type="text/css">
    <script th:src="@{/shoppingcart/cart/js/bootstrap-3.1.1.min.js}" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,300italic,400italic,600,600italic,700,700italic,800,800italic" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Lato:400,100,100italic,300,300italic,400italic,700,700italic,900,900italic" rel="stylesheet" type="text/css">
    <link th:href="@{/shoppingcart/cart/css/animate.min.css}" rel="stylesheet">
    <link th:href="@{/css/styles.css}" rel="stylesheet" />
    <script th:src="@{/shoppingcart/cart/js/wow.min.js}"></script>
    <div th:replace="~{/layout/headerStylesheet.html}"></div>
    <script>
        new WOW().init();
    </script>
    <style>
        .checkout-right, .checkout-right-basket {
            font-size: 16px;
        }
        .checkout-right-basket {
            border: 1px solid #e3e3e3;
            padding: 20px;
            background: #f9f9f9;
        }
        .checkout-right-basket h4 {
            margin-bottom: 20px;
        }
        .checkout-right-basket table {
            width: 100%;
        }
        .checkout-right-basket table td {
            padding: 5px 0;
        }
        .checkout-right-basket .btn {
            margin-bottom: 10px;
            width: 100%;
        }
        .container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
    </style>
</head>

<body>
<!-- Header -->
<div class="header" th:replace="~{/layout/header.html}"></div>

<!-- breadcrumbs -->
<div class="breadcrumbs">
    <div class="container">
        <ol class="breadcrumb breadcrumb1 animated wow slideInLeft" data-wow-delay=".5s">
            <li><a th:href="@{/index}"><span class="glyphicon glyphicon-home" aria-hidden="true"></span>Home</a></li>
            <li class="active">Checkout Page</li>
        </ol>
    </div>
</div>

<!-- checkout -->
<div class="container" style="margin-top: 20px; display: flex; justify-content: space-between;">
    <section class="py-5" style="width: 70%;">
        <h2 class="h5 text-uppercase mb-4">帳單詳細資料</h2>
        <div class="row">
            <div class="col-lg-12">
                <form id="checkoutForm">
                    <div class="row gy-3">
                        <div class="col-lg-6">
                            <label class="form-label text-sm text-uppercase" for="firstName">姓名</label>
                            <input class="form-control form-control-lg" type="text" id="firstName" placeholder="輸入您的姓名">
                        </div>
                        <div class="col-lg-6">
                            <label class="form-label text-sm text-uppercase" for="email">電子郵件地址</label>
                            <input class="form-control form-control-lg" type="email" id="email" placeholder="例如：ABCD@example.com">
                        </div>
                        <div class="col-lg-6">
                            <label class="form-label text-sm text-uppercase" for="phone">電話號碼</label>
                            <input class="form-control form-control-lg" type="tel" id="phone" placeholder="例如：0912345678">
                        </div>
                        <div class="col-lg-6">
                            <label class="form-label text-sm text-uppercase" for="city">縣市</label>
                            <input class="form-control form-control-lg" type="text" id="city">
                        </div>
                        <div class="col-lg-6">
                            <label class="form-label text-sm text-uppercase" for="state">鄉鎮市區</label>
                            <input class="form-control form-control-lg" type="text" id="state">
                        </div>
                        <div class="col-lg-12">
                            <label class="form-label text-sm text-uppercase" for="address">地址：街道名稱/巷/弄/號/樓</label>
                            <input class="form-control form-control-lg" type="text" id="address" placeholder="街道名稱">
                        </div>
                        <div class="col-lg-12">
                            <label class="form-label text-sm text-uppercase" for="addressalt">附加詳細地址</label>
                            <input class="form-control form-control-lg" type="text" id="addressalt" placeholder="(選填)公寓、套房、公司單位等">
                        </div>
                    </div>
                    <h2 class="h5 text-uppercase mt-4">付款信息</h2>
                    <div class="row gy-3">
                        <div class="col-lg-12">
                            <label class="form-label text-sm text-uppercase" for="cardName">持卡人姓名</label>
                            <input class="form-control form-control-lg" type="text" id="cardName" placeholder="持卡人姓名">
                        </div>
                        <div class="col-lg-12">
                            <label class="form-label text-sm text-uppercase" for="cardNumber">卡號</label>
                            <input class="form-control form-control-lg" type="text" id="cardNumber" placeholder="0000 0000 0000 0000">
                        </div>
                        <div class="col-lg-4">
                            <label class="form-label text-sm text-uppercase" for="expMonth">到期日</label>
                            <input class="form-control form-control-lg" type="text" id="expMonth" placeholder="MM">
                        </div>
                        <div class="col-lg-4">
                            <label class="form-label text-sm text-uppercase" for="expYear">到期年份</label>
                            <input class="form-control form-control-lg" type="text" id="expYear" placeholder="YYYY">
                        </div>
                        <div class="col-lg-4">
                            <label class="form-label text-sm text-uppercase" for="cvv">CVC/CVV</label>
                            <input class="form-control form-control-lg" type="text" id="cvv" placeholder="***">
                        </div>
                        <div class="col-lg-12 form-group">
                            <button class="btn btn-primary" type="button" onclick="submitOrder()">立即付款</button>
                        </div>
                    </div>
                </form>
                <div th:if="${message}" class="alert alert-success" role="alert">
                    <span th:text="${message}"></span>
                </div>
                <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
                    <span th:text="${errorMessage}"></span>
                </div>
            </div>
        </div>
    </section>

    <!-- 訂單資訊 -->
    <div class="checkout-right-basket animated wow slideInLeft" data-wow-delay=".5s" style="width: 25%; margin-top: 20px;">
        <h4>訂單資訊</h4>
        <table>
            <tr>
                <td style="font-weight: bold;">商品總數</td>
                <td th:text="${carts.size()}" style="text-align: right;"></td>
            </tr>
            <tr>
                <td style="font-weight: bold;">小計</td>
                <td th:text="'$' + ${totalPrice}" style="text-align: right;"></td>
            </tr>
            <tr>
                <td style="font-weight: bold;">總計</td>
                <td th:text="'$' + ${totalPrice}" style="text-align: right;"></td>
            </tr>
        </table>
        <div style="margin-top: 20px;">
            <a th:href="@{/front/productlist}" class="btn btn-default" style="background-color: black; color: white; text-align: center;">繼續購物</a>
            <a th:href="@{/orders/checkout1}" class="btn btn-default" style="background-color: black; color: white; text-align: center;">結帳</a>
        </div>
    </div>
</div>

<!-- Footer -->
<div th:replace="~{/layout/footer.html}"></div>

<script th:src="@{/shoppingcart/checkout/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/shoppingcart/checkout/vendor/glightbox/js/glightbox.min.js}"></script>
<script th:src="@{/shoppingcart/checkout/vendor/nouislider/nouislider.min.js}"></script>
<script th:src="@{/shoppingcart/checkout/vendor/swiper/swiper-bundle.min.js}"></script>
<script th:src="@{/shoppingcart/checkout/vendor/choices.js/public/assets/scripts/choices.min.js}"></script>
<script th:src="@{/shoppingcart/checkout/js/front.js}"></script>
<script>
    function submitOrder() {
        var userId = document.querySelector(".order-item .product-userId").value;
        var order = {
            orderId: generateOrderId(),
            userId: userId,
            userName: document.getElementById("firstName").value,
            email: document.getElementById("email").value,
            phone: document.getElementById("phone").value,
            city: document.getElementById("city").value,
            district: document.getElementById("state").value,
            address: document.getElementById("address").value,
            detailAddress: document.getElementById("addressalt").value,
            totalAmount: parseFloat(document.getElementById("totalAmount").innerText.replace('$', '')),
            orderDetails: []
        };

        document.querySelectorAll(".order-item").forEach((item, index) => {
            order.orderDetails.push({
                productId: parseInt(item.dataset.productId),
                productName: item.querySelector(".product-name").innerText,
                color: item.querySelector(".product-color") ? item.querySelector(".product-color").innerText : 'N/A',
                storage: item.querySelector(".product-storage") ? item.querySelector(".product-storage").innerText : 'N/A',
                quantity: parseInt(item.querySelector(".product-quantity").innerText),
                price: parseFloat(item.querySelector(".product-price").innerText.replace('$', '')),
                total: parseFloat(item.querySelector(".product-total").innerText.replace('$', ''))
            });
        });

        $.ajax({
            url: '/sellphone/orders/save',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(order),
            success: function(response) {
                alert(response);
                window.location.href = "/checkout/completion";
            },
            error: function(error) {
                alert('提交訂單失敗: ' + error.responseText);
            }
        });
    }

    function generateOrderId() {
        var date = new Date();
        var year = date.getFullYear();
        var month = ('0' + (date.getMonth() + 1)).slice(-2);
        var day = ('0' + date.getDate()).slice(-2);
        var hours = ('0' + date.getHours()).slice(-2);
        var minutes = ('0' + date.getMinutes()).slice(-2);
        var seconds = ('0' + date.getSeconds()).slice(-2);
        var milliseconds = date.getMilliseconds().toString().padStart(3, '0');
        return 'S' + year + month + day + hours + minutes + seconds + milliseconds;
    }
</script>
</body>
</html>
